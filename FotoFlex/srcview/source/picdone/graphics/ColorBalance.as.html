<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>ColorBalance.as</title>
<link rel="stylesheet" type="text/css" href="../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">picdone</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">graphics</span>
<span class="ActionScriptBracket/Brace">{</span>
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">display</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">BitmapData</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">utils</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">ByteArray</span>;
    
    <span class="ActionScriptComment">// white balance utility
</span>    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">ColorBalance</span>
    <span class="ActionScriptBracket/Brace">{</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">CLIPPING</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0.001; <span class="ActionScriptComment">// clipping range for shadow and highlight
</span>        
        <span class="ActionScriptComment">// (color temperature, green component) to sRGB
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">t2rgb</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">green</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">xD</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">yD</span>:<span class="ActionScriptDefault_Text">Number</span>;
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">&gt;</span> 12000<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">=</span> 12000;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">&lt;=</span> 4000<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">=</span> 0.27475e9<span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">-</span> 0.98598e6<span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 1.17444e3<span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">+</span> 0.145986;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">&lt;=</span> 7000<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">=</span> -4.6070e9<span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 2.9678e6<span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.09911e3<span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">+</span> 0.244063;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">=</span> -2.0064e9<span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 1.9018e6<span class="ActionScriptOperator">/</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">*</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> 0.24748e3<span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">+</span> 0.237040;
            <span class="ActionScriptDefault_Text">yD</span> <span class="ActionScriptOperator">=</span> -3 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">+</span> 2.87 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">-</span> 0.275;
            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">x</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">yD</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">y</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 1;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">z</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span>1 <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">xD</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">yD</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">yD</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">r</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 3.24071 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> 1.53726 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">-</span> 0.498571 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">z</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">g</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> -0.969258 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">+</span> 1.87599 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> 0.0415557 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">z</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0.0556352 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">-</span> 0.203996 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">+</span> 1.05707 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">z</span>;
            
            <span class="ActionScriptDefault_Text">g</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">g</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">green</span> <span class="ActionScriptOperator">+</span> 0.000001<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">l</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0.299 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">r</span> <span class="ActionScriptOperator">+</span> 0.587 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">g</span> <span class="ActionScriptOperator">+</span> 0.114 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">b</span>;
            <span class="ActionScriptDefault_Text">r</span> <span class="ActionScriptOperator">/=</span> <span class="ActionScriptDefault_Text">l</span>;
            <span class="ActionScriptDefault_Text">g</span> <span class="ActionScriptOperator">/=</span> <span class="ActionScriptDefault_Text">l</span>;
            <span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">/=</span> <span class="ActionScriptDefault_Text">l</span>;
            
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">r</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">g</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// sRGB to [color temperature, green component]
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">rgb2t</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">r</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">g</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">temperature</span>:<span class="ActionScriptDefault_Text">Number</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">green</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 1;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tmin</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 2000;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">tmax</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 12000;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">br</span>:<span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">b</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">r</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rgb</span>:<span class="ActionScriptDefault_Text">Array</span>;
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tmin</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tmax</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2; <span class="ActionScriptDefault_Text">tmax</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">tmin</span> <span class="ActionScriptOperator">&gt;</span> 10; <span class="ActionScriptDefault_Text">temperature</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">tmin</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">tmax</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> 2<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">rgb</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">t2rgb</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">green</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rgb</span><span class="ActionScriptBracket/Brace">[</span>2<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">rgb</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">br</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">tmax</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">temperature</span>;
                <span class="ActionScriptReserved">else</span> <span class="ActionScriptDefault_Text">tmin</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">temperature</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">green</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">rgb</span><span class="ActionScriptBracket/Brace">[</span>1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">rgb</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">g</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">r</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">temperature</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">green</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// hex to RGB
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">int2rgb</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">color</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">r</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">color</span> <span class="ActionScriptOperator">&gt;&gt;</span> 16;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">g</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">color</span> <span class="ActionScriptOperator">&amp;</span> 0x00FF00<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&gt;&gt;</span> 8;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">color</span> <span class="ActionScriptOperator">&amp;</span> 0x0000FF;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">r</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">g</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">b</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// RGB to hex
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">rgb2int</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">r</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">g</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">b</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">r</span> <span class="ActionScriptOperator">&lt;&lt;</span> 16<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">g</span> <span class="ActionScriptOperator">&lt;&lt;</span> 8<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">b</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">// finding white point by averaging highlights (with clipping pre-applied)
</span>        <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">whitePoint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bmd</span>:<span class="ActionScriptDefault_Text">BitmapData</span><span class="ActionScriptBracket/Brace">)</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">bytes</span>:<span class="ActionScriptDefault_Text">ByteArray</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">getPixels</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">rect</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">clipping</span>:<span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">CLIPPING</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">luma</span>:<span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span>256<span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">lumaWhite</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">rWhite</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">gWhite</span>:<span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bWhite</span>:<span class="ActionScriptDefault_Text">Number</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">t</span>:<span class="ActionScriptDefault_Text">int</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">count</span>:<span class="ActionScriptDefault_Text">int</span>;
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> 256; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptDefault_Text">luma</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">*</span> 4; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+=</span> 4<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">Math</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">round</span><span class="ActionScriptBracket/Brace">(</span>0.299 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> 0.587 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 2<span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">+</span> 0.114 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 3<span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">luma</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptBracket/Brace">]</span><span class="ActionScriptOperator">++</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 255; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&gt;=</span> 0; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">--</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">luma</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">clipping</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">lumaWhite</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">i</span>;
                    <span class="ActionScriptReserved">break</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptReserved">else</span> <span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">luma</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">count</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">rWhite</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">gWhite</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">bWhite</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">width</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">bmd</span><span class="ActionScriptOperator">.</span><span class="ActionScriptDefault_Text">height</span> <span class="ActionScriptOperator">*</span> 4; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+=</span> 4<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptDefault_Text">lumaWhite</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">count</span><span class="ActionScriptOperator">++</span>;
                    <span class="ActionScriptDefault_Text">rWhite</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 1<span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">gWhite</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 2<span class="ActionScriptBracket/Brace">]</span>;
                    <span class="ActionScriptDefault_Text">bWhite</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">bytes</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> 3<span class="ActionScriptBracket/Brace">]</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptDefault_Text">rWhite</span> <span class="ActionScriptOperator">/=</span> <span class="ActionScriptDefault_Text">count</span>;
            <span class="ActionScriptDefault_Text">gWhite</span> <span class="ActionScriptOperator">/=</span> <span class="ActionScriptDefault_Text">count</span>;
            <span class="ActionScriptDefault_Text">bWhite</span> <span class="ActionScriptOperator">/=</span> <span class="ActionScriptDefault_Text">count</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">rWhite</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">gWhite</span><span class="ActionScriptOperator">,</span> <span class="ActionScriptDefault_Text">bWhite</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span></pre></body>
</html>
